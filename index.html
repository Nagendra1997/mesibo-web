<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mesibo Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--SCRIPTINCLUDESTART-->
  <script type="text/javascript" src="https://mesibo.com/mesiboapi.js"></script> 
  <script type="text/javascript" src="scripts/utils.js"></script>
  <script type="text/javascript" src="scripts/localstorage.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <!--SCRIPTINCLUDEEND-->

  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles/chatdesign.css" rel="stylesheet">
</head>
<body>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <div class="container app">
    <div class="row app-one">
      <div class="col-sm-4 side">
        <div class="side-one">
          <div class="row heading">
            <div class="col-sm-3 col-xs-3 heading-avatar">
              <div class="heading-avatar-icon">
                <img src="images/mesibo-logo.png">
              </div>
            </div>
            <div class="col-sm-1 col-xs-1  heading-dot  pull-right">
              <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
            </div>
            <div class="col-sm-2 col-xs-2 heading-compose  pull-right">
              <i class="fa fa-comments fa-2x  pull-right" aria-hidden="true"></i>
            </div>
          </div>

          <div class="row searchBox">
            <div class="col-sm-12 searchBox-inner">
              <div class="form-group has-feedback">
                <input id="searchText" type="text" class="form-control" name="searchText" placeholder="Search">
                <span class="glyphicon glyphicon-search form-control-feedback"></span>
              </div>
            </div>
          </div>

          <div class="row sideBar" id="UserList">
          </div>
        </div>

        <div class="side-two">

          <div class="row newMessage-heading">
            <div class="row newMessage-main">
              <div class="col-sm-2 col-xs-2 newMessage-back">
                <i class="fa fa-arrow-left" aria-hidden="true"></i>
              </div>
              <div class="col-sm-10 col-xs-10 newMessage-title">
                New Chat
              </div>
            </div>
          </div>

          <div class="row composeBox">
            <div class="col-sm-12 composeBox-inner">
              <div class="form-group has-feedback">
                <input id="composeText" type="text" class="form-control" name="searchText" placeholder="Search People">
                <span class="glyphicon glyphicon-search form-control-feedback"></span>
              </div>
            </div>
          </div>

          <div class="row compose-sideBar" id="syncedContactsList">
          </div>
        </div>
      </div>

      <div class="col-sm-8 conversation">
        <div class="row heading">
          <div class="col-sm-2 col-md-1 col-xs-3 heading-avatar">
            <div class="heading-avatar-icon">
              <img src="images/profile/default-profile-icon-16.jpg" 
              id="SelectedUserPicture">
            </div>
          </div>
          <div class="col-sm-8 col-xs-7 heading-name">
            <a class="heading-name-meta" id="SelectedUserName">Mesibo
            </a>
            <span class="heading-online">Online</span>
          </div>
          <div class="col-sm-1 col-xs-1  heading-dot pull-right">
            <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
          </div>
        </div>

        <div class="row message" id="conversation">
          <div class="row message-previous">
            <div class="col-sm-12 previous">
            <!-- <a onclick="previous(this)" id="" name="20">
            Show Previous Message!
          </a> -->
        </div>
      </div>

      <div class="row message-body">
        <div class="col-sm-12 message-main-receiver">
          <div class="receiver">
            <div class="message-text">
             Hi, Welcome to Mesibo!
           </div>
           <span class="message-time pull-right">
            00:39
          </span>
        </div>
      </div>
    </div>

    <div class="row message-body">
      <div class="col-sm-12 message-main-sender">
        <div class="sender">
          <div class="message-text">
            Click on user to select and send a message!
          </div>
          <span class="message-time pull-right">
            00:42
            <img class="status_msg_img" src="images/whatsapp_double_tick_coloured.png"></img>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row reply">
    <div class="col-sm-1 col-xs-1 reply-emojis">
      <i class="fa fa-smile-o fa-2x"></i>
    </div>
    <div class="col-sm-9 col-xs-9 reply-main">
      <textarea class="textarea" rows="1" id="comment" placeholder="Type.."></textarea>
    </div>
    <div class="col-sm-1 col-xs-1 reply-recording">
      <i class="fa fa-microphone fa-2x" aria-hidden="true"></i>
    </div>
    <div class="col-sm-1 col-xs-1 reply-send">
      <i class="fa fa-send fa-2x" aria-hidden="true" onclick="sendMessage()" id='alphBnt'></i>
    </div>
  </div>
</div>
</div>
</div>



<script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">

//GLOBAL SCOPE
AppStorage = new Mesibo_LocalStorage();

// var PhoneBook = LocalStorage_GetPhoneBook();
var PhoneBook = AppStorage.phoneBook;

// var activeUserList = LocalStorage_GetActiveUsers();
var activeUserList = AppStorage.activeUsers;

var contactSyncUsrToken = "5d3ca7a43590fe140baa16ce60ecb159b22401bebe1153bcb";
fetchContacts(contactSyncUsrToken, PhoneBook);
var selected_user = "";
var current_selected_user_name = "";

//Init Display 
Mesibo_AppUtils.displayActiveUsers(activeUserList, PhoneBook);
Mesibo_AppUtils.updateUserListOrder(PhoneBook);

function TestNotify() {}

TestNotify.prototype.Mesibo_OnConnectionStatus = function(status, value) {
  console.log("TestNotify.prototype.Mesibo_OnConnectionStatus: " + status);
}

TestNotify.prototype.Mesibo_OnMessageStatus = function(m) {

  m.peer = AppStorage.getPeerFromId(m.id);
  console.log("TestNotify.prototype.Mesibo_OnMessageStatus: from " + m.peer + " status: " +
    m.status);

  AppStorage.updateItemSent(m);
  var statustick = document.getElementById(m.id);
  Mesibo_AppUtils.updateStatusTick(statustick, m.status);
  Mesibo_AppUtils.updateLastMsg(Mesibo_AppUtils.getUserFromPhone(m.peer, PhoneBook), m.peer);
  Mesibo_AppUtils.updateUserListOrder(PhoneBook);
}

TestNotify.prototype.Mesibo_OnMessage = function(m, data) {
  console.log("===>Mesibo_OnMessage ");

  console.log("TestNotify.prototype.Mesibo_OnMessage: from " + m.peer);
  var string = new TextDecoder("utf-8").decode(data);
  msgRecievedTimeStamp = +new Date;

  if (m.flag == 3) {

    if (selected_user == m.peer) {

      if (!Mesibo_AppUtils.getLastTs(m.peer, PhoneBook) || (!(Mesibo_AppUtils.dateNow(Mesibo_AppUtils.getLastTs(m.peer, PhoneBook)) == Mesibo_AppUtils.dateNow(msgRecievedTimeStamp)))) {

        if (Mesibo_AppUtils.dateNow(msgRecievedTimeStamp) == Mesibo_AppUtils.dateNow(+new Date())) {
          Mesibo_AppUtils.createDateHeaderBlock("Today");
        } else if (Mesibo_AppUtils.dateNow(msgRecievedTimeStamp) == Mesibo_AppUtils.dateYesterday(msgRecievedTimeStamp))
          Mesibo_AppUtils.createDateHeaderBlock("Yesterday");
        else
          Mesibo_AppUtils.createDateHeaderBlock(Mesibo_AppUtils.dateNow(msgRecievedTimeStamp));
      }
      Mesibo_AppUtils.createRecievedBubble({
        'data': string,
        'ts': msgRecievedTimeStamp
      });

      Mesibo_AppUtils.updateScroll();
    }

    AppStorage.updateItemRecieved(m, string);
    Mesibo_AppUtils.updateUserListOrder(PhoneBook);
    Mesibo_AppUtils.updateLastMsg(Mesibo_AppUtils.getUserFromPhone(m.peer, PhoneBook), m.peer);

  }
}
// var accessToken = "aea59d3713701704bed9fd5952d9419ba8c4209a335e664ef2e"
var accessToken = "4080ba6528abe3bdbef60cd497f9193199dadb6b635616e2216a80"
// var accessToken = "8de56f624074861d60f378b0e43cad9b15b11f22859e335398b"

var api = new Mesibo();
api.setAppName("dialogflowmesibo");
// api.setAppName("MyMesiboApp");

api.setListener(new TestNotify());
api.setCredentials(accessToken);
api.start();

function sendMessage() {
  var p = {};
  p.peer = selected_user;

  if (!selected_user) return;

  var id = parseInt(Math.random() * 10000);
  var msgdata = "Hello from Mesibo Javascript API!";

  msgdata = document.getElementById("comment").value;

  if (msgdata) {

    msg_payload = {
      'id': id,
      'peer': p.peer,
      'params': p,
      'data': msgdata,
      'groupid': 0,
      'ts': +new Date,
      'flag': 0,
      'status': MESIBO_MSGSTATUS_OUTBOX
    };

    if (!Mesibo_AppUtils.getLastTs(p.peer, PhoneBook) || (!(Mesibo_AppUtils.dateNow(Mesibo_AppUtils.getLastTs(p.peer, PhoneBook)) == Mesibo_AppUtils.dateNow(msg_payload['ts'])))) {
      if (Mesibo_AppUtils.dateNow(msg_payload['ts']) == Mesibo_AppUtils.dateNow(+new Date()))
        Mesibo_AppUtils.createDateHeaderBlock("Today");
      else
        Mesibo_AppUtils.createDateHeaderBlock(Mesibo_AppUtils.dateNow(msg_payload['ts']));
    }

    AppStorage.newItemSent(id, p.peer, msg_payload);
    AppStorage.msgPeerHash(id, p.peer);

    var retrievedMsgHash = localStorage.getItem("Mesibo_MsgUsr_Hash");
    if (retrievedMsgHash)
      retrievedMsgHash = JSON.parse(retrievedMsgHash);

    Mesibo_AppUtils.createSentBubble(msg_payload);
    api.sendMessage(p, id, msgdata);
    document.getElementById("comment").value = "";
    Mesibo_AppUtils.updateLastMsg(Mesibo_AppUtils.getUserFromPhone(p.peer, PhoneBook), p.peer);
    Mesibo_AppUtils.updateScroll();
    Mesibo_AppUtils.updateUserListOrder(PhoneBook);
  }
}

function loadChatHistory(selected_user_name) {

  //Hide side panel  
  $(".side-two").css({
    "left": "-100%"
  });

  console.log("===>loadChatHistory called ", selected_user_name);

  if (current_selected_user_name)
    document.getElementById(current_selected_user_name).style.backgroundColor =
    "#fff";

  selected_user = PhoneBook[selected_user_name]['phone'];

  if (!(activeUserList.includes(selected_user))) {
    Mesibo_AppUtils.createActivePeerBlock(selected_user_name, PhoneBook);
    activeUserList.push(selected_user);
  }

  $("#SelectedUserName").html(selected_user_name);
  $("#SelectedUserPicture").attr('src', "https://appimages.mesibo.com/" + PhoneBook[selected_user_name]['photo']);

  document.getElementById(selected_user_name).style.backgroundColor = "#e5e5e5";
  $('#conversation').empty();
  AppStorage.loadHistory(selected_user);
  Mesibo_AppUtils.updateLastMsg(selected_user_name, selected_user);
  current_selected_user_name = selected_user_name;
  Mesibo_AppUtils.updateScroll();

}

//Enter to send Message
document.onkeydown = function(e) {
  e = e || window.event;
  switch (e.which || e.keyCode) {
    case 13: //(13 is ascii code for 'ENTER')
      sendMessage();
      if (event.preventDefault) event.preventDefault(); // This should fix it
      break;
  }

}

//Side Panel Display
$(function() {
  $(".heading-compose").click(function() {
    $(".side-two").css({
      "left": "0"
    });
  });

  $(".newMessage-back").click(function() {
    $(".side-two").css({
      "left": "-100%"
    });
  });
})


    </script>
  </body>
  </html>
