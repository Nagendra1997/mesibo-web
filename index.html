<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>web.mesibo.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--SCRIPTINCLUDESTART-->
    <script type="text/javascript" src="https://mesibo.com/mesiboapi.js"></script> 
    <script type="text/javascript" src="scripts/utils.js"></script>
    <script type="text/javascript" src="scripts/localstorage.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!--SCRIPTINCLUDEEND-->

    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles/chatdesign.css" rel="stylesheet">
</head>
<body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<div class="container app">
  <div class="row app-one">
    <div class="col-sm-4 side">
      <div class="side-one">
        <div class="row heading">
          <div class="col-sm-3 col-xs-3 heading-avatar">
            <div class="heading-avatar-icon">
              <img src="images/mesibo-logo.png">
            </div>
          </div>
          <div class="col-sm-1 col-xs-1  heading-dot  pull-right">
            <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
          </div>
          <div class="col-sm-2 col-xs-2 heading-compose  pull-right">
            <i class="fa fa-comments fa-2x  pull-right" aria-hidden="true"></i>
          </div>
        </div>

        <div class="row searchBox">
          <div class="col-sm-12 searchBox-inner">
            <div class="form-group has-feedback">
              <input id="searchText" type="text" class="form-control" name="searchText" placeholder="Search">
              <span class="glyphicon glyphicon-search form-control-feedback"></span>
            </div>
          </div>
        </div>

        <div class="row sideBar" id="UserList">
          <div class="row sideBar-body" onclick="loadChatHistory('Nagendra')" id = "Nagendra">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="images/profile/default-profile-icon-16.jpg">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta" >Nagendra
                  <span class="message-time pull-right">
                    <img src="" class='status_msg_img' id=Nagendra_LastStatus>
                  </span>
                  <p id='Nagendra_LastMsg'></p>      
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right" id='Nagendra_LastDate'>
                </span>
                </div>
              </div>
            </div>
          </div>

          <div class="row sideBar-body" onclick="loadChatHistory('Ankit')" id = "Ankit">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="images/profile/default-profile-icon-16.jpg">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta" >Ankit 
                    <span class="message-time pull-right">
                    <img src="" class='status_msg_img' id=Ankit_LastStatus>
                    </span>
                  <p id='Ankit_LastMsg'> </p>
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right" id='Ankit_LastDate'>
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body" onclick="loadChatHistory('Priya')" id = "Priya">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="images/profile/default-profile-icon-16.jpg">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">Priya
                    <span class="message-status-last pull-right">
                    <img src="" class='status_msg_img' id=Priya_LastStatus>
                    </span>
                  <p id='Priya_LastMsg'></p>
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right" id='Priya_LastDate' >
                </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="side-two">
        <div class="row newMessage-heading">
          <div class="row newMessage-main">
            <div class="col-sm-2 col-xs-2 newMessage-back">
              <i class="fa fa-arrow-left" aria-hidden="true"></i>
            </div>
            <div class="col-sm-10 col-xs-10 newMessage-title">
              New Chat
            </div>
          </div>
        </div>

        <div class="row composeBox">
          <div class="col-sm-12 composeBox-inner">
            <div class="form-group has-feedback">
              <input id="composeText" type="text" class="form-control" name="searchText" placeholder="Search People">
              <span class="glyphicon glyphicon-search form-control-feedback"></span>
            </div>
          </div>
        </div>

        <div class="row compose-sideBar">
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar1.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>

          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar2.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar3.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar4.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar5.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar6.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar2.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar3.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar4.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
          <div class="row sideBar-body">
            <div class="col-sm-3 col-xs-3 sideBar-avatar">
              <div class="avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar5.png">
              </div>
            </div>
            <div class="col-sm-9 col-xs-9 sideBar-main">
              <div class="row">
                <div class="col-sm-8 col-xs-8 sideBar-name">
                  <span class="name-meta">John Doe
                </span>
                </div>
                <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                  <span class="time-meta pull-right">
                </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-8 conversation">
      <div class="row heading">
        <div class="col-sm-2 col-md-1 col-xs-3 heading-avatar">
          <div class="heading-avatar-icon">
            <img src="images/profile/default-profile-icon-16.jpg" 
            id="SelectedUserPicture">
          </div>
        </div>
        <div class="col-sm-8 col-xs-7 heading-name">
          <a class="heading-name-meta" id="SelectedUserName">Mesibo
          </a>
          <span class="heading-online">Online</span>
        </div>
        <div class="col-sm-1 col-xs-1  heading-dot pull-right">
          <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
        </div>
      </div>

      <div class="row message" id="conversation">
        <div class="row message-previous">
          <div class="col-sm-12 previous">
            <!-- <a onclick="previous(this)" id="" name="20">
            Show Previous Message!
            </a> -->
          </div>
        </div>

        <div class="row message-body">
          <div class="col-sm-12 message-main-receiver">
            <div class="receiver">
              <div class="message-text">
               Hi, Welcome to Mesibo!
              </div>
              <span class="message-time pull-right">
                00:39
              </span>
            </div>
          </div>
        </div>

        <div class="row message-body">
          <div class="col-sm-12 message-main-sender">
            <div class="sender">
              <div class="message-text">
                Click on user to select and send a message!
              </div>
              <span class="message-time pull-right">
                00:42
                <img class="status_msg_img" src="images/whatsapp_double_tick_coloured.png"></img>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="row reply">
        <div class="col-sm-1 col-xs-1 reply-emojis">
          <i class="fa fa-smile-o fa-2x"></i>
        </div>
        <div class="col-sm-9 col-xs-9 reply-main">
          <textarea class="form-control" rows="1" id="comment"></textarea>
        </div>
        <div class="col-sm-1 col-xs-1 reply-recording">
          <i class="fa fa-microphone fa-2x" aria-hidden="true"></i>
        </div>
        <div class="col-sm-1 col-xs-1 reply-send">
          <i class="fa fa-send fa-2x" aria-hidden="true" onclick="sendMessage()" id='alphBnt'></i>
        </div>
      </div>
    </div>
  </div>
</div>



<script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">

      var $divs = $("#UserList .row.sideBar-body");
     
    //   var PhoneBook={
    //   'Nagendra':
    //   {'phone':'919999999999',
    //   'photo':'https://bootdey.com/img/Content/avatar/avatar1.png'},
    //   'Ankit':
    //   {'phone':'919999999999',
    //   'photo':'https://bootdey.com/img/Content/avatar/avatar2.png'},
    //   'Priya':
    //   {'phone':'919999999999',
    //   'photo':'https://bootdey.com/img/Content/avatar/avatar3.png'},
    // }; 

    //   localStorage.setItem("Local_PhoneBook",JSON.stringify(PhoneBook));

    //Replace with get list of all users
      //Put list of active contacts in LocalSorage

      Array.prototype.contains = function(v) {
  for (var i = 0; i < this.length; i++) {
    if (this[i] === v) return true;
  }
  return false;
};

Array.prototype.unique = function() {
  var arr = [];
  for (var i = 0; i < this.length; i++) {
    if (!arr.contains(this[i])) {
      arr.push(this[i]);
    }
  }
  return arr;
}


      var active_user_list=localStorage.getItem("Mesibo_MsgUsr_Hash");
      if(active_user_list){
        console.log( JSON.parse(active_user_list));
        active_user_list = Object.values(JSON.parse(active_user_list));
        active_user_list.unique()
      }
      else
        active_user_list=['Nagendra','Ankit','Priya'];

      for(var i =0; i<active_user_list.length;i++) {
        // console.log(active_user_list[i]);
        updateLastMsg(active_user_list[i]);
      }

      updateUserListOrder();

      var selected_user="";
      var current_selected_user_name="";

      function TestNotify() {
      }

  TestNotify.prototype.Mesibo_OnConnectionStatus = function(status, value) {
    console.log("TestNotify.prototype.Mesibo_OnConnectionStatus: "  + status);
    
  }

  TestNotify.prototype.Mesibo_OnMessageStatus = function(m) {

	  // console.log("TestNotify.prototype.Mesibo_OnMessageStatus: from "  + m.peer + " status: " + 
   //    m.status);

    
    // if(!m.peer){
    //   console.log("Peer Null");
    //   m.peer = LocalStorage_GetPeerFromId(m.id);
    // }
    // console.log(m.peer);

    // m.peer='Nagendra';
    m.peer = LocalStorage_GetPeerFromId(m.id);
    console.log("TestNotify.prototype.Mesibo_OnMessageStatus: from "  + m.peer + " status: " + 
      m.status);

    console.log(m);


    LocalStorage_UpdateItemSent(m);
    var statustick=document.getElementById(m.id);
    updateStatusTick(statustick,m.status);
    updateLastMsg(m.peer);
    updateUserListOrder();
  }

  TestNotify.prototype.Mesibo_OnMessage = function(m, data) {
    console.log(m);
    console.log("TestNotify.prototype.Mesibo_OnMessage: from "  + m.peer);
    var string = new TextDecoder("utf-8").decode(data);
    console.log(string)
  
    if(m.flag==3){
      LocalStorage_UpdateItemRecieved(m,string);
      if(selected_user==m.peer)
        createRecievedBubble({'data':string,'ts':+ new Date});
      updateScroll();
      updateLastMsg(m.peer);
      updateUserListOrder();
    }

  }
     var accessToken = "aea59d3713701704bed9fd5952d9419ba8c4209a335e664ef2e" 
        
     var api = new Mesibo();
     api.setAppName("dialogflowmesibo");
     api.setListener(new TestNotify());
     api.setCredentials(accessToken);
     api.start();

    function sendMessage() {
        var p = {};
           p.peer = selected_user;

        console.log("SENDING MSG >>>>>>>>>>>>>>>",selected_user);
        if(!selected_user)return;

        var id = parseInt(Math.random()*10000);
        var msgdata="I have recieved hi!" ;

        msgdata= document.getElementById("comment").value;
      
      	
	    if(msgdata){ 

        	msg_payload={'id':id,'peer':p.peer,'params':p,'data':msgdata,'groupid':0,
        		'ts': + new Date,'flag':0,'status':MESIBO_MSGSTATUS_OUTBOX};
      
        	LocalStorage_NewItemSent(id,p.peer,msg_payload);
          LocalSorage_MsgPeerHash(id,p.peer);

          var retrievedMsgHash = localStorage.getItem("Mesibo_MsgUsr_Hash");
          if(retrievedMsgHash)
          retrievedMsgHash = JSON.parse(retrievedMsgHash);


        	createSentBubble(msg_payload);
          console.log(p,id,msgdata);
        	api.sendMessage(p,id,msgdata);
        	$('textarea').val('');
          updateLastMsg(p.peer);
        	updateScroll();
          updateUserListOrder();
	    }
     }

    function loadChatHistory(selected_user_name){
      console.log(">>>>>>>>>>>>>>",selected_user_name);
      if(current_selected_user_name)
        $('#'+current_selected_user_name).css({"background-color":"#fff"});


      selected_user = selected_user_name;
      $("#SelectedUserName").html(selected_user_name);
      $("#SelectedUserPicture").attr('src','images/profile/default-profile-icon-16.jpg');
      $('#'+selected_user_name).css({"background-color":"#e5e5e5"});
      $('#conversation').empty();
      LocalStorage_LoadHistory(selected_user);
      current_selected_user_name=selected_user_name;
      updateScroll();
      
    }

     document.onkeydown = function (e) {
      e = e || window.event;
      switch (e.which || e.keyCode) {
          case 13 : //Your Code Here (13 is ascii code for 'ENTER')
              sendMessage();
              break;
    }

  }
	$(function(){
    $(".heading-compose").click(function() {
      $(".side-two").css({
        "left": "0"
      });
    });

    $(".newMessage-back").click(function() {
      $(".side-two").css({
        "left": "-100%"
      });
    });
})

  
</script>
</body>
</html>
